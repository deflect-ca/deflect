# What is Deflect

## Overview

Deflect has specialized in defending high-profile human rights and independent media websites since 2010, serving millions of readers readers the world over and confounding the aims of state-sponsored hacking teams trying to silence them. We release our time tested tooling for standing up an entire DDoS mitigation infrastructure, including machine lead bot mitigation, as FOSS - to ensure that these protections are afforded to everyone and DDoS attacks cannot prevent freedom of expression and association on the Internet. We also tackle the problem of censorship from the user&#39;s perspective - looking to circumvent website censorship in their locale - in another one of our [projects.](https://censorship.no/)

This repository allows any individual or organization to setup their own DDoS mitigation service. It contains all necessary components to setup your network controller and edge servers - essentially acting as a reverse proxy to your (clients&#39;) origin web servers. Edge deployment software includes Banjax - regex-based bot detection, challenge and banning software. Optionally, you can also install an instance of [Baskerville](https://github.com/deflect-ca/baskerville) - an anomaly detection system using machine learning to detect malicious network behaivour. Baskerville can be deployed as a module on your edge servers, communicating with our clearinghouse for predictions, or in its entirety with a base model.

## Technology

- [Docker](https://www.docker.com/) (each service/component is run in its own docker container)
- [Nginx](https://www.nginx.com/)
- [Certbot](https://certbot.eff.org/)
- [Bind-server](https://hub.docker.com/r/internetsystemsconsortium/bind9)
- [Kafka-server](https://hub.docker.com/r/wurstmeister/kafka/)
- [Elk Stack](https://www.elastic.co/what-is/elk-stack) (used for visualizing traffic logs generated by nginx)
- [Filebeat](https://www.elastic.co/beats/filebeat)
- [Metricbeat](https://www.elastic.co/beats/metricbeat)
- [Banjax](https://github.com/deflect-ca/banjax)(built in Go)
- [Baskerville](https://github.com/deflect-ca/baskerville)(optional, can be used together with Deflect to detect anomalous traffic and with Banjax to challenge and ban anomalous behavior)

# Basic Component Overview

The diagram below visualizes the basic configuration of different Deflect components.

![](docs/basic.jpg)

**Client Origins:** One or more web servers that host website platforms. They are protected from direct access to the outside world by having incoming connections proxied through one or more edges. All requests to your website(s) will come from these edges.

# Request Life-Cycle

The diagram below highlights the request life-cycle inside a fully-deployed Deflect DDoS mitigation infrastructure.

![](docs/request.png)

# Components &amp; Concepts

## Controller

The controller is where the certbot and bind-server services reside, and should be deployed on its own server. The controller handles SSL certificate generation, as well as DNS configuration propagation.

Site configuration also resides on the controller, and is propagated to each edge whenever a change is made.

The controller presents a necessary soft single point of failure. It is required for propagating DNS changes, and should it go offline - further DNS and network configuration changes cannot be deployed or propagated. For websites that do not change their DNS info often, this is not a major problem. However, if you were to deploy Deflect to a larger network of websites, you will have to consider extra server hardening and masking its location wherever possible. Edges do not publicly expose the location of the controller.

## Edge

The edge server acts as a reverse proxy to the origin web servers. You can setup one or more edges in your network. And you can organize them into one or more dnets (see below). Edges run two docker containers: nginx and Banjax. While nginx handles client requests and caching, Banjax handles several things:

- Hosts a couple of http endpoints that nginx talks to for access control decisions.
- Tails the nginx logs and matches regex rules to make blocking/challenging decisions (like fail2ban)
- Instructs nginx to respond with either a 403 &quot;you are blocked&quot;, a 401 &quot;solve this captcha or javascript proof-of-work challenge&quot;, or proxies the request to the origin server.
- Generates the challenge pages and manages the related cookies.
- creates and expires iptables ban rules.
- Talks to Baskerville (our machine learning bot classification service, if installed &amp; configured) over a Kafka bus.

For more detailed information on [Banjax](https://github.com/deflect-ca/banjax)

Your edges also function as a caching server, as they can serve cached pages to users, and consequently speed-up your page load times. This functionality can be enabled with Nginx&#39;s content caching ability (see below).

## Baskerville

[Baskerville](https://github.com/deflect-ca/baskerville)is our ML-powered anomaly detection system that looks for bot-like behavior in otherwise normal traffic. Although it is not packaged by default with this project, you can install it on a separate server and configure your edges to connect to its kafka server. Once the connection is made, Banjax can receive ban or challenge messages from Baskerville for specific IPs, and Banjax will respond with feedback for IPs base don if they get banned, pass challenges, or fail challenges.

Baskerville will require you to send it logs from each edge. This can be accomplished using filebeat in conjunction with logstash. Specific information can be found on the [Baskerville repo](https://github.com/deflect-ca/baskerville).

## Certbot

The certbot services is installed on the controller, and generates LetsEncrypt certificates for your configured websites. You can also bypass this process by defining your own LE certs and disabling automatic cert generation in the sites.yml file.

## Bind-server

The BIND server handles DNS configuration propagation. You can configure it as you see fit using the included configuration file. What the BIND server does is propagate your website&#39;s DNS zones to the internet&#39;s DNS servers (optionally, your DNS provider) where your site&#39;s A records point to your edges. This allows users (and malicious bots) to visit your website through the edge, as opposed to directly connecting to your origin webserver.

## DNETs

The concept of a DNET is to allow you to organize edges into several groupings, which consequently allows you to organize multiple websites into different DNETs. This organization ability allows you to setup hot/cold edge pools where you can, for example, move actively targeted websites to a &quot;hot&quot; zone where edges in that pool can bear the brunt of an attack while edges in the &quot;cold&quot; zone continue to service other websites without issue.

There are also other uses you can come up with for DNETs like segregating certain types of websites from others. For example, higher traffic websites can be assigned to a specific DNET with more edges, while smaller websites can be setup on DNETs with less edges. The different configurations and uses cases are up to you and your specific needs.

## Edge Rotation/Management

Out of the box, this project does not offer the ability for you to rotate multiple edges in and out of service. When an edge is in service, it is actively ready to receive and respond to requests from visitors to your website. And its IP address is included in the zone transfers to DNS servers around the world. When an edge is out of service, it is still functional, but no longer actively serving traffic.

For this rotation to occur, you need a mechanism to keep track of edge health, and make the necessary DNS zone file changes so that requests are routed correctly.

If you require this kind of functionality, you could build your own management software or you could use [EdgeManage](https://github.com/deflect-ca/edgemanage). We use EdgeManage at Deflect to automatically keep track of our edges&#39; health and rotate them in and out of service when required.

You can have up to 8 active edges at any given time (the limit is based on DNS response packet limitations). When an edge becomes unresponsive, Edgemanage will remove its entry from the zone files for all of your websites and replace it with another edge..

For this to work correctly, you need more edges in your edge pool than you have in active rotation. So, if you have Edgemanage configured to have 4 active edges at any given time, you should have at least 5 edges total in your pool.

## Content Caching

As previously mentioned, you can setup your edges to also at as content caches for static files. Enabling content caching accomplishes two things:

- Your website page loads times speed-up as nginx simply returns cached static files to users as opposed to having your webserver render any dynamically loaded content
- Increases your resilience to DDoS attack, as your origin server is far less affected during attacks, since bots will be receiving cached pages from your edges as opposed to simply getting passed-through to your origin.

To enable content caching, you need to follow the in-depth steps [found here](https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/).

## ELK Stack

You can optionally setup an ELK stack using the included docker images which allow you to monitor and visualize the logs being generated by your edges. Filebeat and Metricbeat are also included in this package to facilitate this functionality. If you already have an ELK stack, you can configure filebeat/metricbeat to push to that environment instead.

## DNS Load Balancing

When running more than one edge in your DNET, you automatically benefit from the way browsers and operating systems determine which A record IP to use to fetch site content.

When you run more than one edge, your websites&#39; DNS A records will contain up to 8 edge IPs (based on the amount of edges and your configuration). When a domain goes through DNS resolution, different operating systems, browsers, and DNS resolvers use various techniques to pick which A record IP is returned for any given request.

That means a browser for User A might use one particular edge IP, while the same browser for User B will use the IP of another edge IP. Some DNS resolvers/operating systems use a round-robin system, while others use a random-like function.

Regardless of the method, investing in multiple edges will bring the added benefit of this load balancing technique to your network, allowing to to handle higher volumes of traffic without hindering performance drastically.

# DNS Options

## DNS Provider

Deflect uses a DNS Provider for client websites, masking our controller&#39;s IP address by having clients nominate our nameservers at their registrar. This is an optional step, though, it is recommended to use a third-party DNS provider for the reasons mentioned above.

When using a 3rd-party DNS provider, you need to configure the bind9 server to send NOTIFY requests to your DNS provider, and they will handle zone propagation and edge IP distribution from that point on.

## Your Own DNS

You can also use a hidden Primary/public Secondary DNS server setup to mask your controller&#39;s location. In this configuration, your controller acts as the hidden Primary, that sends NOTIFY requests to your public Secondary. This effectively makes your Secondary the AUTHORITATIVE name server for your website(s).

# Hardware Considerations

## Controller

Your controller server does not require a lot of resources, as it is mostly handling orchestration to your edges and handling cert generation/DNS propagation. We suggest a minimum of 4GB of memory, 4 CPU cores, 50GB of disk space. If you decide to run the Elk Stack and use Kibana to visualize logs, you will likely need to provision more CPU cores and memory, as well as disk space. This is highly dependent on how much traffic your website(s) generate on a daily basis.

For ideas about sizing machines for the ELK stack, [please see this page](https://www.elastic.co/blog/benchmarking-and-sizing-your-elasticsearch-cluster-for-logs-and-metrics).

## Edges

Edges are for all intents and purposes your public-facing webservers. Requests get sent to these servers, and they proxy those requests to your origin server or return cached content (if enabled). Depending on your traffic volume, and number of edges, you may want to provision sufficient hardware to be able to handle the volume of requests you expect to receive.

We suggest a minimum of 16GB of memory, 4 CPU cores, and 50GB of disk space. Remember that edges are technically throw-away machines. Under a DDoS attack, edges may become overwhelmed and can be rotated out (if implemented) or brought down altogether and have DNS changes point to another, fresh, edge server. Despite this throw-away concept, it is still a good idea to properly provision these servers so that they can serve regular traffic without issue, and can handle normal traffic spikes.

# Installation

## Controller

```bash
git clone https://github.com/equalitie/deflect-next-orchestration.git
cd deflect-next-orchestration
pip install -e .
```
-e is if you need it to be editable

These steps effectively install your controller.From here, you run orchestration scripts (manually or triggered from events or via cron) to accomplish tasks such as:

- Deploy edges
- Update website DNS information
- Change various configuration values

## Edge

Before deploying to edges (or running Deflect in general), you need to make sure you have configured Deflect correct (link to following section).

When provisioning a new edge, you first need to run the following command from the controller:

```bash
python3 orchestration/install\_base.py
```

This will install docker on each edge defined in orchestration/input/config.yaml under dnets\_to\_edges

To update configuration for provisioned edges, run the following command from the controller:

```bash
python3 orchestration/main.py
```

# How to Run

## Configuration

The main configuration files are:

- orchestration/input/config.yml
- orchestration/input/old-sites.yml
- orchestration/system-sites.yml
- orchestration/deflect-next\_config.yml
- local\_certs\_dir = f&quot;input/certs/{formatted\_time}/&quot; # XXX formatted\_time comes from inside the old-sites.yml file

There are example yamls in the respective directories for all the above.
Before running Deflect, you need to have the correct values in the above configuration files.

## Orchestration

Under orchestration there is a main.py file. This will run the three main steps for Deflect and it should be run on the controller:

- [optional] cert\_converter\_main
- install\_delta\_config
- make\_nginx\_public\_main

In short, the following will generate config (from old-sites.yml), get certs from LetsEncrypt, and build/start/reload any containers that need it.

```bash
python3 orchestration/main.py
```

---

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
<img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a><br />
This work is copyright (c) 2020, eQualit.ie inc., and is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
